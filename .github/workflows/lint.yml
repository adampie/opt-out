---
name: "Lint"
"on":
  pull_request:
    branches:
      - "main"
jobs:
  detect-changes:
    name: "Detect changes"
    runs-on: "ubuntu-latest"
    permissions:
      pull-requests: "read"
    outputs:
      nix: ${{ steps.filter.outputs.nix }}
      shell: ${{ steps.filter.outputs.shell }}
      markdown: ${{ steps.filter.outputs.markdown }}
      yaml-toml: ${{ steps.filter.outputs.yaml-toml }}
    steps:
      - uses: "actions/checkout@v6"
      - uses: "dorny/paths-filter@v3"
        id: "filter"
        with:
          filters: |
            nix:
              - '**/*.nix'
              - 'flake.lock'
            shell:
              - '**/*.sh'
            markdown:
              - '**/*.md'
              - '.markdownlint*'
            yaml-toml:
              - '**/*.yml'
              - '**/*.yaml'
              - '**/*.toml'

  flake-check:
    name: "Flake check"
    needs: "detect-changes"
    if: ${{ needs.detect-changes.outputs.nix == 'true' }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v6"
      - uses: "DeterminateSystems/determinate-nix-action@v3"
      - uses: "DeterminateSystems/magic-nix-cache-action@main"
      - run: "nix flake check"

  lint-nix:
    name: "Lint and format Nix"
    needs: "detect-changes"
    if: ${{ needs.detect-changes.outputs.nix == 'true' }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v6"
      - uses: "DeterminateSystems/determinate-nix-action@v3"
      - uses: "DeterminateSystems/magic-nix-cache-action@main"
      - run: |
          nix-shell -p statix deadnix nixfmt-rfc-style \
            --run 'statix check . && deadnix . && nixfmt --check .'

  lint-shell:
    name: "Lint shell scripts"
    needs: "detect-changes"
    if: ${{ needs.detect-changes.outputs.shell == 'true' }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v6"
      - uses: "DeterminateSystems/determinate-nix-action@v3"
      - uses: "DeterminateSystems/magic-nix-cache-action@main"
      - run: |
          nix-shell -p shellcheck shfmt \
            --run 'shellcheck scripts/*.sh && shfmt -d scripts/*.sh'

  lint-markdown:
    name: "Lint Markdown"
    needs: "detect-changes"
    if: ${{ needs.detect-changes.outputs.markdown == 'true' }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v6"
      - uses: "actions/setup-node@v6"
        with:
          node-version: "22"
      - run: "npx markdownlint-cli2 '**/*.md'"

  lint-yaml-toml:
    name: "Lint YAML and TOML"
    needs: "detect-changes"
    if: ${{ needs.detect-changes.outputs.yaml-toml == 'true' }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v6"
      - uses: "DeterminateSystems/determinate-nix-action@v3"
      - uses: "DeterminateSystems/magic-nix-cache-action@main"
      - run: |
          nix-shell -p yamllint taplo \
            --run 'yamllint . && taplo check'
